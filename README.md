# srs-box 规则集生成器

一个用于生成 sing-box 规则集的自动化工具，支持从多个数据源下载 IP 列表和规则集，并将其编译为 sing-box 可用的 .srs 格式文件。

## 功能特性

- 🌐 **多源下载**: 支持从多个 URL 下载 IP 列表和 JSON 规则集
- 🔄 **自动合并**: 智能合并多个数据源的规则
- ⚡ **并发处理**: 支持并发下载，提高处理效率
- 🛡️ **错误恢复**: 具备重试机制和错误处理能力
- 📊 **统一日志**: 提供清晰的执行状态和进度显示
- 🎯 **内存优化**: 流式处理大文件，避免内存溢出

## 项目结构

```
srs-box/
├── main.py                 # 主程序入口
├── config.json            # 配置文件
├── src/
│   ├── app.py             # 应用主逻辑
│   ├── services/          # 核心服务模块
│   │   ├── downloader.py  # 下载服务
│   │   ├── processor.py   # 规则集处理服务
│   │   └── compiler.py    # 编译服务
│   └── utils/             # 工具模块
│       ├── config.py      # 配置管理
│       ├── logger.py      # 统一日志
│       ├── file_utils.py  # 文件操作工具
│       └── network.py     # 网络工具
├── temp/                  # 临时文件目录
└── data/                  # 示例数据文件
```

## 快速开始

### 环境要求

- Python 3.7+
- 网络连接（用于下载数据源和 sing-box 工具）

### 安装使用

1. 克隆项目
```bash
git clone <repository-url>
cd srs-box
```

2. 配置规则集
编辑 `config.json` 文件，添加你需要的规则集：

```json
{
    "rulesets": {
        "cn_ip": [
            "https://example.com/china-ip.txt"
        ],
        "telegram_ip": [
            "https://core.telegram.org/resources/cidr.txt"
        ],
        "custom_rules": [
            "https://example.com/custom-rules.json"
        ]
    },
    "sing_box": {
        "version": "1.12.8",
        "platform": "linux-amd64"
    },
    "version": 3
}
```

3. 运行程序
```bash
python main.py
```

## 配置说明

### 配置文件格式

配置文件 `config.json` 包含以下字段：

- **rulesets**: 规则集配置，键为规则集名称，值为 URL 数组
- **sing_box**: sing-box 工具配置
  - `version`: sing-box 版本号
  - `platform`: 目标平台（如 linux-amd64, windows-amd64）
- **version**: 配置文件版本号

### 支持的数据源类型

1. **文本 IP 列表** (.txt)
   - 每行一个 IP 地址或 CIDR 块
   - 支持 IPv4 和 IPv6

2. **JSON 规则集** (.json)
   - sing-box 标准格式的 JSON 规则集
   - 支持域名、IP、进程等多种规则类型

## 使用示例

### 基本使用

```bash
# 运行完整流程（下载 -> 处理 -> 编译）
python main.py
```

### 输出文件

程序运行后会生成以下文件：

- `规则集名称.json`: 处理后的 JSON 格式规则集
- `规则集名称.srs`: 编译后的二进制规则集文件
- `temp/`: 临时文件目录（自动清理）

## 高级功能

### 并发配置

程序默认使用 5 个并发连接下载文件。如需调整，可以修改代码中的相关参数。

### 缓存机制

程序会检查文件的修改时间，避免重复下载未更改的文件，提高执行效率。

### 错误处理

- 网络错误：自动重试最多 3 次
- 单个文件失败：跳过并继续处理其他文件
- 配置错误：立即停止并提供详细错误信息

## 日志说明

程序使用统一的日志格式，包含以下级别：

- **INFO**: 一般信息和进度
- **SUCCESS**: 成功完成的操作
- **WARNING**: 警告信息，不影响继续执行
- **ERROR**: 错误信息，可能影响结果

日志格式示例：
```
[2024-01-01 12:00:00] [INFO] 🌏 srs-box 规则集生成器启动
[2024-01-01 12:00:01] [SUCCESS] ✅ cn_ip 规则集下载完成 (12 个文件)
[2024-01-01 12:00:02] [WARNING] ⚠️ telegram_ip 部分文件下载失败，继续处理
```

## 故障排除

### 常见问题

1. **网络连接失败**
   - 检查网络连接
   - 确认 URL 地址正确
   - 查看是否需要代理设置

2. **配置文件错误**
   - 验证 JSON 格式是否正确
   - 检查必需字段是否存在
   - 确认 URL 列表不为空

3. **编译失败**
   - 检查 sing-box 工具是否正确下载
   - 确认平台配置是否匹配
   - 查看临时文件是否完整

### 调试模式

如需查看详细的执行信息，可以修改日志级别或添加调试输出。

## 贡献指南

欢迎提交 Issue 和 Pull Request 来改进项目。

### 开发环境

1. 克隆项目
2. 安装依赖（如有）
3. 运行测试
4. 提交更改

## 许可证

请查看 LICENSE 文件了解许可证信息。

## 更新日志

### v2.0.0 (重构版本)
- 重构项目架构，采用模块化设计
- 统一日志输出格式
- 优化性能，支持并发下载
- 增强错误处理和恢复机制
- 改进内存使用效率